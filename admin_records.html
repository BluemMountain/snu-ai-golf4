<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상세 스코어 기록 관리 - SNU AI CEO 4기</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            padding: 40px 20px;
            background-color: #f5f5f5;
        }

        .admin-nav {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-btn {
            text-decoration: none;
            color: #1e3a2b;
            font-weight: bold;
            border: 1px solid #1e3a2b;
            padding: 8px 15px;
            border-radius: 4px;
        }

        .back-btn:hover {
            background: #1e3a2b;
            color: #fff;
        }

        .action-bar {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .add-round-btn {
            background-color: #577b2d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .add-round-btn:hover {
            background-color: #436024;
        }

        .save-all-btn {
            background-color: #2980b9;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Modal Style for Adding Scores */
        #add-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            overflow-y: auto;
        }

        .modal-body {
            background: #fff;
            width: 90%;
            max-width: 800px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 8px;
        }

        .member-score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #eee;
        }

        .score-input-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f9f9f9;
            padding: 8px;
            border-radius: 4px;
        }

        .score-input-group label {
            font-size: 0.9rem;
            font-weight: bold;
        }

        .score-input-group input {
            width: 60px;
            padding: 5px;
            border: 1px solid #ddd;
            text-align: center;
        }

        /* Override for easier horizontal scroll */
        .score-table-container {
            background: #fff;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="admin-nav">
            <a href="index.html" class="back-btn">← 메인 페이지로 돌아가기</a>
            <h1 style="font-family: 'Noto Serif KR', serif; color: #1e3a2b;">상세 스코어 기록 관리</h1>
            <div></div> <!-- Spacer -->
        </div>

        <div class="action-bar">
            <span>새로운 라운드 정보를 추가하시겠습니까?</span>
            <button class="add-round-btn" onclick="openAddModal()">+ 라운드 스코어 추가</button>
            <button class="save-all-btn" onclick="exportToCSV()">현재 데이터 CSV로 내보내기</button>
            <button
                style="background: #e74c3c; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor:pointer;"
                onclick="clearAddedRounds()">추가 기록 전체 삭제</button>
        </div>

        <div class="table-container-wrapper">
            <div id="admin-full-score-container" class="score-table-container">
                <div class="loading-spinner">데이터를 분석 중입니다...</div>
            </div>
        </div>
    </div>

    <!-- 라운드 추가 모달 -->
    <div id="add-modal">
        <div class="modal-body">
            <h2 style="margin-top: 0; color: #1e3a2b; border-bottom: 2px solid #577b2d; padding-bottom: 10px;">새 라운드 스코어
                입력</h2>

            <div style="display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 15px; margin-top: 20px;">
                <div class="form-group">
                    <label>날짜 (예: 260325)</label>
                    <input type="text" id="new-date" placeholder="YYMMDD"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd;">
                </div>
                <div class="form-group">
                    <label>골프장 명</label>
                    <input type="text" id="new-venue" placeholder="신원CC"
                        style="width: 100%; padding: 10px; border: 1px solid #ddd;">
                </div>
                <div class="form-group">
                    <label>회차 번호</label>
                    <input type="number" id="new-count" style="width: 100%; padding: 10px; border: 1px solid #ddd;">
                </div>
            </div>

            <p style="margin-top: 20px; font-weight: bold; color: #666;">회원별 스코어 입력 (불참 시 빈칸)</p>
            <div id="member-input-list" class="member-score-grid">
                <!-- Javascript will populate this list -->
            </div>

            <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="cta-button secondary" onclick="closeAddModal()"
                    style="border-radius: 4px; padding: 10px 25px;">취소</button>
                <button class="cta-button" onclick="saveNewRound()" style="border-radius: 4px; padding: 10px 40px;">기록
                    저장</button>
            </div>
        </div>
    </div>

    <!-- Aggressive Cache Clearing & SW Deregistration -->
    <script>
        async function clearAllCaches() {
            try {
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) { await registration.unregister(); }
                }
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    for (let name of cacheNames) { await caches.delete(name); }
                }
            } catch (err) { console.error('Cache clearing failed:', err); }
        }
        clearAllCaches();
    </script>

    <!-- Data Logic -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="script.js?v=2.4"></script>
    <script>
        // Overrides or additional logic for admin page
        const container = document.getElementById('admin-full-score-container');

        // Initial Admin Render
        function refreshAdminTable() {
            const rawData = parseCSV(CSV_DATA_STRING.trim());
            // Merge with localStorage data if any
            const addedRounds = JSON.parse(localStorage.getItem('snu_golf_added_rounds') || '[]');

            if (addedRounds.length > 0) {
                addedRounds.forEach(round => {
                    rawData.push(round);
                });
            }

            renderTable(rawData, container, true);
        }

        // Wait for script.js to load or just call after a bit
        setTimeout(refreshAdminTable, 100);

        function openAddModal() {
            const modal = document.getElementById('add-modal');
            const inputList = document.getElementById('member-input-list');
            inputList.innerHTML = '';

            const data = parseCSV(CSV_DATA_STRING.trim());
            const members = data[0].slice(3); // Get member names
            const nextCount = (data.length - 2) + JSON.parse(localStorage.getItem('snu_golf_added_rounds') || '[]').length + 1;

            document.getElementById('new-count').value = nextCount;

            members.forEach(name => {
                const group = document.createElement('div');
                group.className = 'score-input-group';
                group.innerHTML = `
                    <label>${name}</label>
                    <input type="number" class="member-score" data-name="${name}" placeholder="-">
                `;
                inputList.appendChild(group);
            });

            modal.style.display = 'block';
        }

        function closeAddModal() {
            document.getElementById('add-modal').style.display = 'none';
        }

        function saveNewRound() {
            const date = document.getElementById('new-date').value.trim();
            const venue = document.getElementById('new-venue').value.trim();
            const count = document.getElementById('new-count').value;

            if (!date || !venue) {
                alert('날짜와 장소를 입력해주세요.');
                return;
            }

            const scoreInputs = document.querySelectorAll('.member-score');
            const newRow = [count, date, venue];

            scoreInputs.forEach(input => {
                newRow.push(input.value || ''); // Empty if not entered
            });

            const addedRounds = JSON.parse(localStorage.getItem('snu_golf_added_rounds') || '[]');
            addedRounds.push(newRow);
            localStorage.setItem('snu_golf_added_rounds', JSON.stringify(addedRounds));

            alert('라운드 기록이 추가되었습니다.');
            closeAddModal();
            refreshAdminTable();
        }

        function clearAddedRounds() {
            if (confirm('추가된 모든 기록을 삭제하시겠습니까? 원본 데이터는 유지됩니다.')) {
                localStorage.removeItem('snu_golf_added_rounds');
                refreshAdminTable();
            }
        }

        function exportToCSV() {
            const rawData = parseCSV(CSV_DATA_STRING.trim());
            const addedRounds = JSON.parse(localStorage.getItem('snu_golf_added_rounds') || '[]');
            const fullData = [...rawData, ...addedRounds];

            const csvContent = fullData.map(row => row.join(',')).join('\n');
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);

            link.setAttribute("href", url);
            link.setAttribute("download", "snu_golf_full_scores.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            alert('CSV 파일이 생성되었습니다. 이 파일의 내용을 scores.csv에 덮어쓰거나 AI에게 전달하여 script.js를 업데이트할 수 있습니다.');
        }
    </script>
</body>

</html>